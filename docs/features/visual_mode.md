# 🎬 可视化答题模式

## 📖 功能介绍

可视化答题模式是ExamPilot的一个强大功能，允许您**实时观看**AI答题的全过程。

### ✨ 主要特性

- 🖥️ **真实浏览器窗口**：弹出实际的Firefox/Chrome浏览器
- 👀 **全程可视**：每一步操作都清晰可见
- 🐌 **慢动作播放**：800ms延迟，方便您观察
- ✋ **手动提交**：答完后由您检查并决定是否提交
- ⏱️ **充足时间**：浏览器保持打开10分钟
- 🔄 **自动触发**：答题完成后自动打开浏览器窗口

---

## 🚀 快速开始

### 步骤1：启用可视化模式

#### 方式A：通过前端设置页面（推荐）

1. 访问前端应用
2. 进入"系统设置"页面
3. 找到"答题设置"区域
4. 打开"可视化答题模式"开关
5. 点击"保存设置"

#### 方式B：通过API

```bash
curl -X PUT http://localhost:8000/api/settings/visual_mode \
  -H "Content-Type: application/json" \
  -d '{
    "key": "visual_mode",
    "value": true,
    "value_type": "bool",
    "description": "可视化答题模式（弹出浏览器窗口，用户可见全过程）",
    "category": "answering"
  }'
```

---

### 步骤2：开始答题

1. **输入问卷URL**
2. **点击"解析问卷"**（这一步不会弹出浏览器）
3. **配置答题选项**（选择模式、问题等）
4. **点击"开始答题"**

---

### 步骤3：观看AI答题过程

答题开始后的流程：

1. **后台生成答案**：LLM 先推理出所有答案（不弹出浏览器）
2. **自动触发提交**：答案生成完毕后，系统自动触发提交
3. **浏览器弹出**：Firefox 浏览器窗口自动弹出
4. **慢动作填写**：AI 以慢动作（800ms延迟）逐题填写答案
5. **实时观看**：您可以看到每个答案的填写过程

前端会显示：
```
🎬 可视化模式运行中
浏览器窗口已弹出，您可以实时观看答题过程
```

控制台日志：
```
🎬 可视化答题模式已启用
📺 浏览器窗口即将弹出，您可以实时观看答题过程
🌐 可视化模式：浏览器窗口已打开
✓ 可视化模式：已填写 div1
✓ 可视化模式：已填写 div2
...
```

---

### 步骤4：检查并提交答案

所有答案填写完毕后，控制台显示：

```
============================================================
✅ 可视化模式：所有答案已填写完毕！
📌 请在浏览器窗口中检查答案
📌 检查无误后，请手动点击【提交】按钮
📌 浏览器窗口将保持打开，方便您操作
============================================================
⏰ 浏览器将保持打开10分钟，供您检查和提交...
```

此时您需要：

1. 👀 在浏览器中仔细检查所有答案
2. 🔍 如发现错误，可以手动修改
3. ✅ 确认无误后，**手动点击浏览器中的【提交】按钮**
4. 🎉 提交成功！

---

## 📋 完整操作流程

```
┌─────────────────────────────────────────────────────────┐
│ 1. 启用可视化模式                                       │
│    前端设置页面 或 API设置                              │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 2. 输入问卷URL并解析                                    │
│    https://ks.wjx.com/xxx                               │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 3. 点击"开始答题"                                       │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 4. 🧠 LLM 推理生成所有答案                              │
│    （后台运行，不弹出浏览器）                           │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 5. 🖥️ Firefox浏览器窗口弹出                             │
│    - 窗口大小：1400x900                                 │
│    - 慢动作：每步延迟800ms                              │
│    - 优先使用Firefox（避免Chromium崩溃）                │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 6. 📝 AI逐题填写答案（慢动作，您可观看）                │
│    第1题: 单选题 → 选择B                                │
│    第2题: 填空题 → 填写"人工智能"                       │
│    第3题: 多选题 → 选择A,C,D                            │
│    ...                                                  │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 7. ✅ 答题完成                                          │
│    - 浏览器保持打开                                     │
│    - 不会自动提交                                       │
│    - 等待您检查                                         │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 8. 👤 您的操作                                          │
│    - 检查所有答案                                       │
│    - 发现错误可手动修改                                 │
│    - 确认无误后，点击【提交】                           │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 9. 🎉 提交成功                                          │
│    浏览器跳转到完成页面                                 │
└─────────────────────────────────────────────────────────┘
```

---

## ⚙️ 配置选项

### 调整浏览器保持打开时间

**默认**：10分钟（600秒）

**修改位置**：`backend/services/platforms/wenjuanxing.py`

```python
# 第148行附近
await asyncio.sleep(600)  # 修改这个数字（单位：秒）

# 示例：
await asyncio.sleep(1800)  # 30分钟
await asyncio.sleep(300)   # 5分钟
```

---

### 调整慢动作速度

**默认**：800ms

**修改位置**：`backend/services/platforms/wenjuanxing.py`

```python
# 第112行附近
slow_mo=800 if visual_mode else None,

# 修改为更慢：
slow_mo=1500 if visual_mode else None,  # 1.5秒

# 修改为更快：
slow_mo=500 if visual_mode else None,   # 0.5秒
```

---

### 调整浏览器窗口大小

**默认**：1400x900

**修改位置**：`backend/services/platforms/wenjuanxing.py`

```python
# 第117行附近
await page.set_viewport_size({"width": 1400, "height": 900})

# 修改为全屏：
await page.set_viewport_size({"width": 1920, "height": 1080})
```

---

## 🔧 技术实现

### 浏览器引擎选择

系统会自动选择最佳的浏览器引擎：

1. **优先使用 Firefox**：避免 macOS 上 Chromium 的崩溃问题
2. **回退到 Chromium**：如果 Firefox 不可用，使用更稳定的启动参数

```python
try:
    browser = await p.firefox.launch(
        headless=not visual_mode,
        slow_mo=800 if visual_mode else None,
    )
except Exception:
    browser = await p.chromium.launch(
        headless=not visual_mode,
        slow_mo=800 if visual_mode else None,
        args=['--disable-dev-shm-usage', '--disable-gpu', '--no-sandbox']
    )
```

### 前端实现要点

**自动触发提交**：

```typescript
answeringWs.on('complete', () => {
  if (visualModeRef.current) {
    setTimeout(() => {
      answeringWs.submitAnswers();  // 自动触发，打开浏览器
    }, 1000);
  }
});
```

**使用 useRef 避免闭包问题**：

```typescript
const visualModeRef = useRef(false);
visualModeRef.current = isVisual;  // 确保获取最新值
```

---

## ⚠️ 注意事项

### ✅ 适用场景

- 少量题目的问卷（< 50题）
- 需要人工审核的重要问卷
- 测试和调试答题逻辑
- 演示和教学用途
- 第一次使用 ExamPilot

### ❌ 不适用场景

- 大量题目（> 100题，太慢）
- 云服务器无显示环境
- 需要批量答题的场景
- 定时任务/无人值守

### 🔧 环境要求

- ✅ **本地开发**：完全支持
- ⚠️ **云服务器**：需要 X11/VNC 或虚拟显示
- ❌ **无头环境**：不支持（无法显示GUI）

### 💡 最佳实践

1. **首次使用**：先用小问卷测试
2. **检查答案**：不要完全依赖AI，务必人工检查
3. **修改答案**：发现错误可直接在浏览器中修改
4. **及时提交**：检查完立即提交，不要等10分钟
5. **关闭模式**：正式批量使用时关闭，提高速度

---

## 🐛 故障排除

### 问题1：浏览器没有弹出

**可能原因**：
- 可视化模式未启用
- 前端闭包问题（旧值）
- 答题完成但未自动触发提交

**解决方案**：

```bash
# 1. 检查当前设置
curl http://localhost:8000/api/settings/visual_mode

# 2. 如果value为false，启用它
curl -X PUT http://localhost:8000/api/settings/visual_mode \
  -H "Content-Type: application/json" \
  -d '{"key":"visual_mode","value":true,"value_type":"bool"}'

# 3. 重启后端服务
# 4. 刷新前端页面
```

---

### 问题2：Chromium 崩溃（macOS）

**错误信息**：
```
Received signal 11 SEGV_ACCERR
Target page, context or browser has been closed
```

**解决方案**：

已自动处理！系统会优先使用 Firefox，避免此问题。

如需手动安装 Firefox：
```bash
.venv/bin/python -m playwright install firefox
```

---

### 问题3：云服务器报错 "cannot open display"

**原因**：服务器没有图形界面

**解决方案**：

```bash
# 安装虚拟显示（Ubuntu/Debian）
sudo apt-get update
sudo apt-get install xvfb

# 使用 xvfb 启动服务
xvfb-run -a .venv/bin/python -m backend.main
```

---

### 问题4：答题太慢

**原因**：慢动作延迟设置太高

**解决方案**：调低 `slow_mo` 值（见上文"调整慢动作速度"）

---

## 📊 对比：可视化 vs 非可视化

| 特性 | 可视化模式 | 非可视化模式 |
|------|-----------|-------------|
| 浏览器窗口 | ✅ 显示 | ❌ 隐藏（headless） |
| 答题速度 | 🐌 慢（800ms/步） | ⚡ 快（无延迟） |
| 用户参与 | 👤 手动提交 | 🤖 自动提交 |
| 适用题量 | < 50题 | 不限 |
| 环境要求 | 需要GUI | 无要求 |
| 信任度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 调试能力 | ⭐⭐⭐⭐⭐ | ⭐⭐ |

---

## 🎓 使用建议

### 建议开启场景

1. **第一次使用ExamPilot**：观察AI如何答题
2. **重要问卷**：人工审核确保准确
3. **复杂题型**：检查AI理解是否正确
4. **调试模式**：查找答题逻辑问题
5. **演示展示**：向他人展示功能

### 建议关闭场景

1. **批量答题**：需要快速完成
2. **简单问卷**：AI准确率高，无需检查
3. **生产环境**：云服务器无GUI
4. **定时任务**：无人值守的自动化
5. **大量题目**：>100题，太耗时

---

## 📞 获取帮助

如有问题，请：

1. **查看日志**：`data/logs/exampilot.log`
2. **检查设置**：`GET /api/settings/visual_mode`
3. **查看前端控制台**：浏览器开发者工具
4. **提交Issue**：[GitHub Issues](https://github.com/your-repo/issues)

---

## 📝 相关文档

- [API密钥加密](./api_encryption.md)
- [题型使用指南](../guides/question_types.md)
- [故障排除](../troubleshooting/common_issues.md)

---

**最后更新**：2025-11-07

**祝您使用愉快！🎉**

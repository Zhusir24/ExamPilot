# 知识库添加文档卡住问题排查

## 问题描述
添加文本文档时一直显示"添加中"，无响应。

## 已修复的问题

### 1. Embedding服务配置问题 ✓
**原因**: `backend/api/knowledge.py` 使用环境变量配置，但环境变量未设置。  
**修复**: 改为从数据库读取已激活的Embedding配置（与websocket.py保持一致）。

### 2. 日志不详细
**原因**: 添加文档过程中缺少详细日志，无法定位卡住的环节。  
**修复**: 添加了完整的日志追踪：
- 文档添加的5个步骤都有日志
- Embedding API调用有详细日志（请求和响应）
- 错误时输出完整堆栈

### 3. 超时时间不足
**原因**: 前端60秒超时，对于大文档可能不够。  
**修复**: 
- 前端超时时间: 60秒 → 180秒
- Embedding API超时: 60秒 → 120秒

## 排查步骤

### 1. 测试Embedding服务
```bash
python test_embedding.py
```
如果测试通过，说明Embedding服务配置正确。

### 2. 重启后端服务
修改代码后需要重启：
```bash
# 停止当前服务 (Ctrl+C)
python -m backend.main
```

### 3. 尝试添加文档
在知识库页面添加一个简单的文档：
- 标题: 测试
- 内容: 这是一个测试文档

### 4. 查看详细日志
后端终端会显示详细的处理过程：
```
========== 开始添加文档: 测试 ==========
1/5: 创建文档记录...
✓ 文档记录创建成功，ID: 1
2/5: 文档分块...
✓ 文档分成 1 块
3/5: 保存分块记录到数据库...
✓ 保存 1 个分块记录成功
4/5: 生成向量...
→ 调用批量Embedding API: text-embedding-v4, 文本数量: 1
← 批量Embedding成功，生成 1 个向量
✓ 成功生成并保存 1 个向量
5/5: 更新文档元数据并提交...
========== ✓ 成功添加文档: 测试 ==========
```

## 可能的其他原因

如果问题仍然存在，检查：

### 1. API配额/限流
- 检查阿里云API配额是否耗尽
- 检查是否触发了频率限制

### 2. 网络问题
- 检查服务器是否能访问 `https://dashscope.aliyuncs.com`
- 尝试: `curl https://dashscope.aliyuncs.com`

### 3. API Key权限
- 确认API Key有embedding权限
- 确认API Key未过期

### 4. 内容过长
- 如果内容特别长（>100KB），会分成很多块
- 每块都要调用Embedding API，会比较慢
- 建议分批添加，或减小文档大小

## 日志级别调整

如果需要更详细的调试信息，修改 `backend/core/config.py`:
```python
log_level: str = "DEBUG"  # 从 "INFO" 改为 "DEBUG"
```

## 联系方式

如果问题持续，请提供：
1. 后端完整日志输出
2. 浏览器控制台错误信息
3. 添加的文档内容长度

